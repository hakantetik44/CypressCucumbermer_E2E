name: Ablysen_E2E Test Automation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * *'  # Exécute à minuit chaque jour

# Autorisations de niveau supérieur pour tous les jobs
permissions:
  contents: write
  pages: write
  id-token: write
  checks: write
  actions: write
  deployments: write
  statuses: write
  issues: write
  pull-requests: write
  security-events: write

# Configuration de GitHub Pages au niveau du référentiel
env:
  GITHUB_PAGES: true
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  cypress-run:
    name: 🧪 Tests Cypress
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Télécharger le Code
      uses: actions/checkout@v4

    - name: 🟢 Configurer Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: 📦 Vérifier package.json
      run: |
        if [ ! -f package.json ]; then
          echo '{
            "name": "ablysen-e2e",
            "version": "1.0.0",
            "description": "Ablysen E2E Tests with Cypress",
            "scripts": {
              "test": "cypress run",
              "cypress:open": "cypress open"
            },
            "dependencies": {
              "cypress": "^13.6.6",
              "@badeball/cypress-cucumber-preprocessor": "^20.0.1",
              "@bahmutov/cypress-esbuild-preprocessor": "^2.2.0",
              "multiple-cucumber-html-reporter": "^3.6.1"
            }
          }' > package.json
        fi

    - name: 📥 Installer les Dépendances
      run: |
        npm install
        npx cypress verify

    - name: 🌐 Installer Chrome
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable

    - name: 🧪 Exécuter les Tests Cypress
      run: |
        echo "Heure de début des tests: $(date '+%Y-%m-%d %H:%M:%S')"
        mkdir -p cypress/reports/json
        npx cypress run --browser chrome
      continue-on-error: true

    - name: 📊 Générer le Rapport HTML
      if: always()
      run: |
        mkdir -p cypress/reports/html
        node -e '
        const report = require("multiple-cucumber-html-reporter");
        report.generate({
          jsonDir: "cypress/reports/json",
          reportPath: "cypress/reports/html",
          metadata: {
            browser: { name: "chrome", version: "latest" },
            device: "GitHub Actions VM",
            platform: { name: "ubuntu", version: "latest" }
          },
          customData: {
            title: "Informations d'"'"'Exécution",
            data: [
              { label: "Projet", value: "Ablysen E2E" },
              { label: "Date d'"'"'Exécution", value: new Date().toISOString() }
            ]
          }
        });'

    - name: 📊 Télécharger les Rapports de Test
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cypress-reports
        path: |
          cypress/reports/html
          cypress/screenshots
          cypress/videos
        retention-days: 30

  pages:
    name: 🌐 GitHub Pages
    needs: cypress-run
    runs-on: ubuntu-latest
    if: always()
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: 📥 Télécharger les Rapports de Test
      uses: actions/download-artifact@v4
      with:
        name: cypress-reports
        path: cypress-reports

    - name: 📝 Créer index.html
      run: |
        mkdir -p cypress-reports
        echo '<!DOCTYPE html>
        <html>
        <head>
            <title>Rapport de Tests Cypress - Ablysen</title>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0;url=./html/index.html">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                h1 { color: #2c3e50; }
                p { color: #34495e; }
            </style>
        </head>
        <body>
            <h1>Redirection vers le Rapport de Tests</h1>
            <p>Si vous n'"'"'êtes pas redirigé automatiquement, <a href="./html/index.html">cliquez ici</a>.</p>
        </body>
        </html>' > cypress-reports/index.html

    - name: 🔧 Configuration de GitHub Pages
      uses: actions/configure-pages@v4
      
    - name: 📤 Télécharger les Artefacts
      uses: actions/upload-pages-artifact@v3
      with:
        path: cypress-reports

    - name: 🚀 Déployer sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify:
    name: 📢 Notification
    needs: [cypress-run, pages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: 📋 Vérification du Statut
      run: |
        if [[ "${{ needs.cypress-run.result }}" == "success" ]]; then
          echo "## ✅ Tests Terminés avec Succès" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ❌ Erreur de Test Détectée" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.pages.result }}" == "success" ]]; then
          echo "## 🌐 Rapport Publié avec Succès" >> $GITHUB_STEP_SUMMARY
          echo "📊 [Rapport de Test](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "## ⚠️ Erreur de Publication du Rapport" >> $GITHUB_STEP_SUMMARY
        fi 